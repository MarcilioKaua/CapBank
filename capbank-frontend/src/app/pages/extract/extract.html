<div class="extract-container">
  @if (isMobile()) {
  <mat-toolbar class="mobile-header">
    <button mat-icon-button (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <span class="mobile-header__title">Extrato</span>
    <button mat-icon-button>
      <mat-icon>more_vert</mat-icon>
    </button>
  </mat-toolbar>
  } @if (!isMobile()) {
  <nav class="breadcrumb">
    <a routerLink="/dashboard" class="breadcrumb__link">Dashboard</a>
    <mat-icon class="breadcrumb__separator">chevron_right</mat-icon>
    <span class="breadcrumb__current">Extrato</span>
  </nav>
  <div class="page-header">
    <h1 class="page-title">Extrato</h1>
    <p class="page-subtitle">Acompanhe todas as suas transações</p>
  </div>
  }

  <div class="filters-section">
    @if (isMobile()) {
    <div class="period-chips">
      @for (option of periodOptions; track option.value) {
      <mat-chip-option
        [selected]="selectedPeriod() === option.value"
        (click)="selectPeriod(option.value)"
        class="period-chip"
      >
        {{ option.label.replace('Últimos ', '').replace(' dias', ' dias') }}
      </mat-chip-option>
      }
    </div>
    }
    <form [formGroup]="filterForm" class="filters-form">
      @if (!isMobile()) {
      <div class="desktop-filters">
        <mat-form-field class="filter-field">
          <mat-label>Período</mat-label>
          <mat-select formControlName="period">
            @for (option of periodOptions; track option.value) {
            <mat-option [value]="option.value">
              {{ option.label }}
            </mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field class="filter-field">
          <mat-label>Tipo</mat-label>
          <mat-select formControlName="type">
            @for (option of typeOptions; track option.value) {
            <mat-option [value]="option.value">
              {{ option.label }}
            </mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field class="filter-field search-field">
          <mat-label>Buscar</mat-label>
          <input matInput formControlName="search" placeholder="Buscar por descrição..." />
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <button mat-flat-button color="primary" class="export-btn" (click)="exportPDF()">
          <mat-icon>picture_as_pdf</mat-icon>
          Exportar PDF
        </button>
      </div>
      } @if (isMobile()) {
      <div class="mobile-filters">
        <div class="mobile-filter-row">
          <mat-form-field appearance="outline" class="mobile-select">
            <mat-select formControlName="type">
              <mat-option *ngFor="let option of typeOptions" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <button mat-icon-button class="export-mobile-btn" (click)="exportPDF()">
            <mat-icon>download</mat-icon>
          </button>
        </div>

        <mat-form-field appearance="outline" class="mobile-search">
          <input matInput formControlName="search" placeholder="Buscar por descrição..." />
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>
      </div>
      }
    </form>
  </div>

  @if (!isMobile()) {
  <div class="desktop-content">
    <div class="transaction-group">
      @for (group of groupedTransactions(); track group.date) {
      <div class="group-header">
        <h3 class="group-date">{{ group.date }}</h3>
        <div class="group-summary">
          <span class="transaction-count">{{ numberOfTransactions(group) }} </span>
        </div>
      </div>

      <mat-card class="transactions-table-card">
        <table mat-table [dataSource]="group.transactions" class="transactions-table">
          <ng-container matColumnDef="time">
            <th mat-header-cell *matHeaderCellDef>Hora</th>
            <td mat-cell *matCellDef="let transaction">{{ formatTime(transaction.date) }}</td>
          </ng-container>

          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>Descrição</th>
            <td mat-cell *matCellDef="let transaction">
              <div class="description-cell">
                <div class="transaction-icon" [style.background-color]="transaction.iconColor">
                  <mat-icon>{{ transaction.icon }}</mat-icon>
                </div>
                <div class="description-content">
                  <span class="description-main">{{
                    transaction.description.split(' - ')[0]
                  }}</span>
                  <span class="description-sub">{{
                    transaction.description.split(' - ')[1] || ''
                  }}</span>
                </div>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef>Categoria</th>
            <td mat-cell *matCellDef="let transaction">
              <span class="category-badge" [class]="'category-badge--' + transaction.type">
                {{ getTransactionCategory(transaction) }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="value">
            <th mat-header-cell *matHeaderCellDef>Valor</th>
            <td mat-cell *matCellDef="let transaction">
              <span
                class="amount"
                [class]="transaction.type === 'deposit' ? 'amount--positive' : 'amount--negative'"
              >
                {{ formatAmount(transaction.amount, transaction.type) }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="balance">
            <th mat-header-cell *matHeaderCellDef>Saldo</th>
            <td mat-cell *matCellDef="let transaction">
              <span class="balance">{{ formatBalance(transaction.balance || 0) }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Ações</th>
            <td mat-cell *matCellDef="let transaction">
              <button mat-icon-button (click)="viewDetails(transaction.id)">
                <mat-icon>visibility</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      </mat-card>
      }
    </div>
  </div>
  } @if (isMobile()) {
  <div class="mobile-content">
    <div *ngFor="let group of groupedTransactions()" class="mobile-group">
      <div class="mobile-group-header">
        <span class="mobile-group-date">{{ group.date }}</span>
        <span
          class="mobile-group-total"
          [class]="
            group.totalPositive > group.totalNegative ? 'amount--positive' : 'amount--negative'
          "
        >
          {{
            group.totalPositive > group.totalNegative
              ? formatAmount(group.totalPositive - group.totalNegative, 'deposit')
              : formatAmount(group.totalNegative - group.totalPositive, 'withdrawal')
          }}
        </span>
      </div>

      <div class="mobile-transactions">
        <div
          *ngFor="let transaction of group.transactions"
          class="mobile-transaction"
          (click)="viewDetails(transaction.id)"
        >
          <div class="mobile-transaction__icon" [style.background-color]="transaction.iconColor">
            <mat-icon>{{ transaction.icon }}</mat-icon>
          </div>

          <div class="mobile-transaction__content">
            <div class="mobile-transaction__main">
              <span class="mobile-transaction__description">{{
                transaction.description.split(' - ')[0]
              }}</span>
              <span
                class="mobile-transaction__amount"
                [class]="transaction.type === 'deposit' ? 'amount--positive' : 'amount--negative'"
              >
                {{ formatAmount(transaction.amount, transaction.type) }}
              </span>
            </div>
            <div class="mobile-transaction__sub">
              <span class="mobile-transaction__detail">{{
                transaction.description.split(' - ')[1] || getTransactionCategory(transaction)
              }}</span>
              <span class="mobile-transaction__balance">{{
                formatBalance(transaction.balance || 0)
              }}</span>
            </div>
            <div class="mobile-transaction__time">{{ formatTime(transaction.date) }}</div>
          </div>

          <mat-icon class="mobile-transaction__arrow">chevron_right</mat-icon>
        </div>
      </div>
    </div>
  </div>
  }

  <div class="pagination-section">
    @if (!isMobile()) {
    <div class="desktop-pagination">
      <mat-paginator
        [length]="filteredTransactions().length"
        [pageSize]="10"
        [pageSizeOptions]="[5, 10, 20]"
        aria-label="Selecione página"
      >
      </mat-paginator>
    </div>
    } @if (isMobile()) {
    <div class="mobile-pagination">
      <div class="pagination-info">
        <span>Mostrando 1-10 de {{ filteredTransactions().length }} transações</span>
      </div>
      <div class="pagination-controls">
        <button mat-icon-button disabled>
          <mat-icon>chevron_left</mat-icon>
        </button>
        <span class="page-indicator">1 de 3</span>
        <button mat-icon-button>
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </div>
    }
  </div>
</div>
